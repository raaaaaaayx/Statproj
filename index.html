<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AP Statistics Student Quality Simulation</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/hyperscript.org@0.9.12"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #333;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .hidden {
            display: none;
        }
        canvas {
            max-width: 100%;
            height: auto !important;
        }
        .simulation-log {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .definition-box, .procedure-box, .introduction-box {
            background: #e9f7ef;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            margin: 20px 0;
        }
        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
        }
        input[type="number"] {
            padding: 8px;
            width: 100px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AP Statistics Unit 4 Simulation Project</h1>
        <p><em>By Ray Xu, McQueen Hong, Nicole Wang, Lucas Pan</em></p>

        <!-- Introduction Section -->
        <div class="introduction-box">
            <h2>Introduction</h2>
            <p>The simulation evaluates academic quality in a K-12 education system in China. An initial score was randomly assigned to students representing their academic quality, and students were randomly placed into different schools (Good, Regular, or Bad) with different probabilities to improve, keep, or reduce student’s quality each year. The simulation model begins at kindergarten, reassigning students into different middle and high school base on their quality on the previous stage. The goal of this simulation is to analyze how K-12 education system in China works, how different type of schools can influence student’s final academic outcome, and the necessary proportions of different types of middle and high school to accommodate the student’s placements.</p>
        </div>

        <!-- Definition Section -->
        <div class="definition-box">
            <h2>Definition</h2>
            <p>A student's quality can be measured on a 0-9 scale, and there are good schools, regular schools, and bad schools. A good school has a 40% chance of improving a student's quality by 1 (if possible), 30% chance of keeping it the same, 20% chance of reducing the quality by 1, and 10% chance of keeping it the same but the student repeats a grade. For a regular school, the percentages are 30%, 40%, 20%, and 10%, respectively. For a bad school, they are 20%, 30%, 30%, and 20%.</p>
            <p>A student will start at kindergarten with a random quality between 2 and 6 with equal likelihood, with 30% probability of being in a good school, 40% probability of being in a regular school, and 30% probability of being in a bad school. When they get to grade 6, they will be placed in a middle school based on their quality: 7-9 good, 3-6 regular, 0-2 bad. This happens similarly for high school in grade 9. In the end, we can consider: if the proportion of good: regular : bad primary schools is 30%:40%:30%, what are the appropriate proportions of good : regular : bad middle schools and high schools to accommodate the students' placements. Also, what is the distribution of student qualities at the end of each grade level, including 12th grade.</p>
        </div>

        <!-- Procedure Section -->
        <div class="procedure-box">
            <h2>Procedure</h2>
            <p>In terms of implementation, since the simulation does not track the number of years a student spends in school, the probability of repeating a year is equally distributed among the other three outcomes (improve, keep, reduce). This leads to the following effective probabilities used in the code:</p>
            <p>For a Good School:<br>
            •+1: P(0.4333)<br>
            •+0: P(0.3333)<br>
            • −1: P(0.2333)</p>
            <p>For a Regular School:<br>
            •+1: P(0.3333)<br>
            •+0: P(0.4333)<br>
            • −1: P(0.2333)</p>
            <p>For a Bad School:<br>
            •+1: P(0.2667)<br>
            •+0: P(0.3667)<br>
            • −1: P(0.3667)</p>
            <ol>
                <li>For each student, they will be assigned a random integer between 2-6 by <code>random.choice([2, 3, 4, 5, 6])</code>. It is definitely random since it is processed by code so there will be no bias.</li>
                <li>These students are randomly assigned to different elementary schools (for K-5, a total of 6 years). This process is done by:
                    <pre><code>const r_elem = Math.random();
let elem_school = r_elem &lt; 0.3 ? 'G' : r_elem &lt; 0.7 ? 'R' : 'B';</code></pre>
                    The code above will generate any number between 0 to 1. Based on the number generated, students with a value below 0.3 will go to a good primary school, students with a value below 0.7 will go to a regular primary school, and students with a value of 0.7 and above will go to a bad primary school.
                </li>
                <li>For each of the 6 years in elementary school, the student's quality score is updated once per year using the <code>step</code> function, which applies the probabilities specific to their elementary school (<code>elem_school</code>).</li>
                <li>Based on the quality score after elementary school (grade 5), these students are assigned to their middle school by the <code>assignSchool</code> function:
                    <pre><code>function assignSchool(q) {
    if (q >= 7) return 'G';
    if (q >= 3) return 'R';
    return 'B';
}</code></pre>
                </li>
                <li>During the 3-year middle school period, the student's quality score is updated once per year using the <code>step</code> function, which now applies the probabilities specific to their assigned middle school (<code>mid_school</code>).</li>
                <li>After 3 years of middle school, the <code>assignSchool</code> function is used again to determine which type of high school the student will attend.</li>
                <li>During the 4-year high school period, the student's quality score is updated once per year using the <code>step</code> function, which now applies the probabilities specific to their assigned high school (<code>hs_school</code>).</li>
                <li>The final output is a list of integers representing the final quality score of each simulated student, generated by calling the <code>getFinalQualities(n)</code> function. The value <code>n</code> is the number of students participating in the simulation.</li>
            </ol>
        </div>

        <!-- Simulation Controls -->
        <label for="student-count">Number of Students to Simulate:</label>
        <input type="number" id="student-count" name="student-count" min="1" max="10000" value="4000">
        <button onclick="runSimulation()">Run Simulation</button>

        <div id="results-section" class="hidden">
            <h2>Simulation Results</h2>
            <div class="stats-grid" id="stats-container"></div>
            <div>
                <h3>Population Distribution</h3>
                <canvas id="histogram-chart"></canvas>
            </div>
            <button onclick="simulateSingleStudent()">Simulate a Single Student's Journey</button>
        </div>

        <div id="single-student-section" class="hidden">
            <h2>Single Student Simulation</h2>
            <div id="journey-log" class="simulation-log"></div>
            <div>
                <h3>Quality Progression</h3>
                <canvas id="progression-chart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Simulation parameters
        const PROBS = {
            'G': [0.4333, 0.3333, 0.2333], // [up, same, down]
            'R': [0.3333, 0.4333, 0.2333],
            'B': [0.2667, 0.3667, 0.3667]
        };

        const SCHOOL_LABELS = { 'G': 'Good', 'R': 'Regular', 'B': 'Bad' };

        function clamp(x) {
            return Math.max(0, Math.min(9, x));
        }

        function step(q, school) {
            const [up, same, down] = PROBS[school];
            const r = Math.random();
            if (r < down) {
                return clamp(q - 1);
            } else if (r < down + same) {
                return q;
            } else {
                return clamp(q + 1);
            }
        }

        function assignSchool(q) {
            if (q >= 7) return 'G';
            if (q >= 3) return 'R';
            return 'B';
        }

        function getFinalQualities(n) {
            const finals = [];
            for (let i = 0; i < n; i++) {
                let q = [2, 3, 4, 5, 6][Math.floor(Math.random() * 5)];
                // Elementary School Assignment
                const r_elem = Math.random();
                let elem_school = r_elem < 0.3 ? 'G' : r_elem < 0.7 ? 'R' : 'B';

                // K-5 (6 years)
                for (let y = 0; y < 6; y++) {
                    q = step(q, elem_school);
                }

                // Middle School Assignment & Simulation (3 years)
                let mid_school = assignSchool(q);
                for (let y = 0; y < 3; y++) {
                    q = step(q, mid_school);
                }

                // High School Assignment & Simulation (4 years)
                let hs_school = assignSchool(q);
                for (let y = 0; y < 4; y++) {
                    q = step(q, hs_school);
                }

                finals.push(q);
            }
            return finals;
        }

        // Stats functions
        function calculateMean(data) {
            return data.reduce((a, b) => a + b, 0) / data.length;
        }

        function calculateMedian(data) {
            const sorted = [...data].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
        }

        function calculateMode(data) {
            const freq = {};
            data.forEach(val => freq[val] = (freq[val] || 0) + 1);
            let maxFreq = 0;
            let mode = -1;
            for (const val in freq) {
                if (freq[val] > maxFreq) {
                    maxFreq = freq[val];
                    mode = parseInt(val);
                }
            }
            return mode;
        }

        function calculateStdDev(data) {
            const mean = calculateMean(data);
            const variance = data.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / (data.length - 1);
            return Math.sqrt(variance);
        }

        function calculateIQR(data) {
            const sorted = [...data].sort((a, b) => a - b);
            const q25 = quantile(sorted, 0.25);
            const q75 = quantile(sorted, 0.75);
            return q75 - q25;
        }

        function quantile(arr, q) {
            const pos = (arr.length - 1) * q;
            const base = Math.floor(pos);
            const rest = pos - base;
            if (arr[base + 1] !== undefined) {
                return arr[base] + rest * (arr[base + 1] - arr[base]);
            } else {
                return arr[base];
            }
        }

        // Visualization
        let histogramChart = null;
        let progressionChart = null;

        function renderHistogram(data) {
            const ctx = document.getElementById('histogram-chart').getContext('2d');
            if (histogramChart) histogramChart.destroy();

            // Count frequencies for bins 0-9
            const bins = Array(10).fill(0);
            data.forEach(val => bins[val]++);

            histogramChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: bins.map((_, i) => i.toString()),
                    datasets: [{
                        label: 'Frequency',
                        data: bins,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        },
                        x: {
                            title: { display: true, text: 'Final Quality Score' }
                        }
                    }
                }
            });
        }

        function renderProgressionChart(scores) {
            const ctx = document.getElementById('progression-chart').getContext('2d');
            if (progressionChart) progressionChart.destroy();

            progressionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: scores.length}, (_, i) => i+1),
                    datasets: [{
                        label: 'Quality Score',
                        data: scores,
                        fill: false,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 9,
                            ticks: { stepSize: 1 }
                        },
                        x: {
                            title: { display: true, text: 'Year' }
                        }
                    }
                }
            });
        }

        // Main simulation runner
        function runSimulation() {
            const nInput = document.getElementById('student-count').value;
            const n = parseInt(nInput) || 4000; // Default to 4000 if invalid

            if (n <= 0) {
                alert("Please enter a number greater than 0.");
                return;
            }

            const results = getFinalQualities(n);

            // Calculate stats
            const mean = calculateMean(results).toFixed(2);
            const median = calculateMedian(results).toFixed(2);
            const mode = calculateMode(results);
            const stdDev = calculateStdDev(results).toFixed(2);
            const iqr = calculateIQR(results).toFixed(2);

            // Update UI
            document.getElementById('stats-container').innerHTML = `
                <div class="stat-card"><strong>Mean:</strong><br>${mean}</div>
                <div class="stat-card"><strong>Median:</strong><br>${median}</div>
                <div class="stat-card"><strong>Mode:</strong><br>${mode}</div>
                <div class="stat-card"><strong>Std Dev:</strong><br>${stdDev}</div>
                <div class="stat-card"><strong>IQR:</strong><br>${iqr}</div>
            `;

            renderHistogram(results);
            document.getElementById('results-section').classList.remove('hidden');
        }

        // Single student simulation
        function simulateSingleStudent() {
            let log = '';
            let q = [2, 3, 4, 5, 6][Math.floor(Math.random() * 5)];
            log += `Initial Quality: ${q}\n`;

            // Elementary School Assignment
            const r_elem = Math.random();
            let elem_school = r_elem < 0.3 ? 'G' : r_elem < 0.7 ? 'R' : 'B';
            log += `\nAssigned to Elementary School: ${SCHOOL_LABELS[elem_school]}\n`;

            const allScores = [q];
            // K-5 (6 years)
            for (let y = 0; y < 6; y++) {
                const oldQ = q;
                q = step(q, elem_school);
                allScores.push(q);
                log += `Year ${y+1} (Elem): ${oldQ} -> ${q}\n`;
            }

            // Middle School Assignment & Simulation (3 years)
            let mid_school = assignSchool(q);
            log += `\nEnd of Elementary. Quality: ${q}. Assigned to Middle School: ${SCHOOL_LABELS[mid_school]}\n`;
            for (let y = 0; y < 3; y++) {
                const oldQ = q;
                q = step(q, mid_school);
                allScores.push(q);
                log += `Year ${y+1} (Mid): ${oldQ} -> ${q}\n`;
            }

            // High School Assignment & Simulation (4 years)
            let hs_school = assignSchool(q);
            log += `\nEnd of Middle School. Quality: ${q}. Assigned to High School: ${SCHOOL_LABELS[hs_school]}\n`;
            for (let y = 0; y < 4; y++) {
                const oldQ = q;
                q = step(q, hs_school);
                allScores.push(q);
                log += `Year ${y+1} (HS): ${oldQ} -> ${q}\n`;
            }

            log += `\nFinal Quality: ${q}\n`;
            document.getElementById('journey-log').textContent = log;
            renderProgressionChart(allScores);
            document.getElementById('single-student-section').classList.remove('hidden');
        }
    </script>
</body>
</html>
